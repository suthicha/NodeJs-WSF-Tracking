{"version":3,"sources":["../../src/controller/shipment.js"],"names":["squel","require","db","httpMsg","helper","settings","exports","checkExists","req","resp","callback","data","body","sql","select","from","where","expr","and","TaxNo","BookingNo","OBL","HBL","MasterJobNo","toString","executeSqlWithConnection","dbConfig","err","length","ex","add","Error","deptDate","Date","DepartureDate","arrivalDate","ArrivalDate","deliveryDate","DeliveryDate","insert","into","set","StringNull","JobNo","BranchNo","CustomerNo","CustomerName","CarrierBookingNo","getFullYear","getMonth","getDate","MotherVessel","FeederVessel","ContainerNo","CreateBy","dontQuote","Remark","console","log","execCommandWithConnection","show500","update","table","UpdateBy","delete","TrxNo","get","taxno","orderno","or"],"mappings":"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","file":"shipment.js","sourcesContent":["var squel = require('squel');\nvar db = require('../core/db');\nvar httpMsg = require('../core/httpMsg');\nvar helper = require('../core/helper');\nvar settings = require('../settings');\n\nexports.checkExists = function(req, resp, callback){\n  try{\n    var data = req.body;  \n    var sql = squel.select()\n          .from(\"SFT_Shipments\")\n          .where(\n            squel.expr()\n            .and(\"TaxNo = ?\", data.TaxNo)\n            .and(\"BookingNo = ?\", data.BookingNo)\n            .and(\"OBL = ?\", data.OBL)\n            .and(\"HBL = ?\", data.HBL)\n            .and(\"MasterJobNo = ?\", data.MasterJobNo)\n            .and(\"Status <= ?\", \"99\")\n          )\n          .toString()\n\n      db.executeSqlWithConnection(settings.dbConfig, sql, function(data, err) {\n        if (err){\n            //httpMsg.show500(req, resp, err);\n            callback(false);\n        }\n        else {\n          callback(data.length >= 1? true:false);  \n        }\n      })\n\n  }catch (ex){\n    callback(false);\n  }\n\n}\n\nexports.add = function(req, resp) {\n  try {\n    if (!req.body) throw new Error(\"Input not valid\");\n    var data = req.body;\n\n    if (data){\n      var deptDate = new Date(data.DepartureDate);      \n      var arrivalDate = new Date(data.ArrivalDate);\n      var deliveryDate = new Date(data.DeliveryDate);\n      \n      var sql = squel.insert()\n          .into(\"SFT_Shipments\")\n          .set(\"MasterJobNo\", helper.StringNull(data.MasterJobNo))\n          .set(\"JobNo\", helper.StringNull(data.JobNo))\n          .set(\"TaxNo\", helper.StringNull(data.TaxNo))\n          .set(\"BranchNo\", helper.StringNull(data.BranchNo))\n          .set(\"BookingNo\", helper.StringNull(data.BookingNo))\n          .set(\"CustomerNo\", helper.StringNull(data.CustomerNo))\n          .set(\"CustomerName\", helper.StringNull(data.CustomerName))\n          .set(\"CarrierBookingNo\", helper.StringNull(data.CarrierBookingNo))\n          .set(\"OBL\", helper.StringNull(data.OBL))\n          .set(\"HBL\", helper.StringNull(data.HBL))\n          .set(\"DepartureDate\", deptDate.getFullYear() + \"-\" + (deptDate.getMonth() + 1) +\"-\" + deptDate.getDate())\n          .set(\"MotherVessel\", helper.StringNull(data.MotherVessel))\n          .set(\"FeederVessel\", helper.StringNull(data.FeederVessel))\n          .set(\"ArrivalDate\", arrivalDate.getFullYear() + \"-\" + (arrivalDate.getMonth() + 1) +\"-\" + arrivalDate.getDate())\n          .set(\"ContainerNo\", helper.StringNull(data.ContainerNo))\n          .set(\"DeliveryDate\", deliveryDate.getFullYear() + \"-\" + (deliveryDate.getMonth() + 1) +\"-\" + deliveryDate.getDate())\n          .set(\"CreateBy\", helper.StringNull(data.CreateBy))\n          .set(\"CreateDate\", \"GETDATE()\", { dontQuote: true })\n          .set(\"UpdateBy\", \"\")\n          .set(\"UpdateDate\", \"19000101\")\n          .set(\"Status\", \"1\")\n          .set(\"Remark\", helper.StringNull(data.Remark))\n          .toString();\n          console.log(sql);\n          helper.execCommandWithConnection(req, resp, sql, settings.dbConfig);\n    }\n\n  }catch(ex){\n    httpMsg.show500(req, resp, ex);\n  }\n}\n\nexports.update = function(req, resp) {\n  \n  try {\n    if (!req.body) throw new Error(\"Input not valid\");\n    var data = req.body;\n\n    if (data){\n      var deptDate = new Date(data.DepartureDate);\n      var arrivalDate = new Date(data.ArrivalDate);\n      var deliveryDate = new Date(data.DeliveryDate);\n\n      var sql = squel.update()\n          .table(\"SFT_Shipments\")\n          .set(\"MasterJobNo\", helper.StringNull(data.MasterJobNo))\n          .set(\"JobNo\", helper.StringNull(data.JobNo))\n          .set(\"TaxNo\", helper.StringNull(data.TaxNo))\n          .set(\"BranchNo\", helper.StringNull(data.BranchNo))\n          .set(\"BookingNo\", helper.StringNull(data.BookingNo))\n          .set(\"CustomerNo\", helper.StringNull(data.CustomerNo))\n          .set(\"CustomerName\", helper.StringNull(data.CustomerName))\n          .set(\"CarrierBookingNo\", helper.StringNull(data.CarrierBookingNo))\n          .set(\"OBL\", helper.StringNull(data.OBL))\n          .set(\"HBL\", helper.StringNull(data.HBL))\n          .set(\"DepartureDate\", deptDate.getFullYear() + \"-\" + (deptDate.getMonth() + 1) +\"-\" + deptDate.getDate())\n          .set(\"MotherVessel\", helper.StringNull(data.MotherVessel))\n          .set(\"FeederVessel\", helper.StringNull(data.FeederVessel))\n          .set(\"ArrivalDate\", arrivalDate.getFullYear() + \"-\" + (arrivalDate.getMonth() + 1) +\"-\" + arrivalDate.getDate())\n          .set(\"ContainerNo\", helper.StringNull(data.ContainerNo))\n          .set(\"DeliveryDate\", deliveryDate.getFullYear() + \"-\" + (deliveryDate.getMonth() + 1) +\"-\" + deliveryDate.getDate())\n          .set(\"UpdateBy\", helper.StringNull(data.UpdateBy))\n          .set(\"UpdateDate\", \"GETDATE()\", { dontQuote: true })\n          .set(\"Remark\", helper.StringNull(data.Remark))\n          .where(\n            squel.expr()\n            .and(\"TaxNo = ?\", data.TaxNo)\n            .and(\"BookingNo = ?\", data.BookingNo)\n            .and(\"OBL = ?\", data.OBL)\n            .and(\"HBL = ?\", data.HBL)\n            .and(\"MasterJobNo = ?\", data.MasterJobNo)\n          )\n          .toString();\n          \n          helper.execCommandWithConnection(req, resp, sql, settings.dbConfig);\n    }\n\n  }catch(ex){\n    httpMsg.show500(req, resp, ex);\n  }\n}\n\nexports.delete = function(req, resp) {\n\n  try{\n    if (!req.body) throw new Error(\"Input not valid\");\n    var data = req.body;\n\n    if (data) {\n      var sql = squel.update()\n          .table(\"SFT_Shipments\")\n          .set(\"Status\",\"99\")\n          .where(\"TrxNo = ?\", data.TrxNo)\n          .toString();\n\n      helper.execCommandWithConnection(req, resp, sql, settings.dbConfig);    \n    }\n\n  }catch(ex) {\n    httpMsg.show500(req, resp, ex);\n  }\n\n}\n\nexports.get = function(req, resp, taxno, orderno) {\n    try{\n        if (!taxno) throw new Error(\"Input not valid\");\n        \n        var sql = squel.select()\n            .from(\"SFT_Shipments\")\n            .where(\"TaxNo = ?\", taxno)\n            .where(\"Status < ?\", \"99\")\n            .where(\n                squel.expr()\n                .or(\"BookingNo = ?\", orderno)\n                .or(\"CarrierBookingNo = ?\", orderno)\n                .or(\"OBL = ?\", orderno)\n                .or(\"HBL = ?\", orderno)\n            )\n            .toString();\n           \n        helper.execCommandWithConnection(req, resp, sql, settings.dbConfig);\n\n    }catch(ex){\n        httpMsg.show500(req, resp, ex);\n    }\n}\n\n\n\n"]}